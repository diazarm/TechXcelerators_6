import swaggerJSDoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';
import { Express } from 'express';

const options: swaggerJSDoc.Options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Scala Learning API',
      version: '1.0.0',
      description: `
# API para el sistema de gesti√≥n de recursos educativos de Scala Learning

## üîê C√≥mo autenticarte:

1. **Obtener token**: Usa el endpoint \`POST /api/users/login\` con tus credenciales
2. **Autorizar**: Haz clic en el bot√≥n **"Authorize" üîí** (arriba a la derecha)
3. **Ingresar token**: Pega el token obtenido (sin "Bearer", solo el token)
4. **¬°Listo!**: Ahora puedes usar todos los endpoints protegidos

## üë§ Usuarios de prueba:

**Tipos de autenticaci√≥n:**
- **Admin**: Requiere email + contrase√±a ‚Üí administrador@scalalearning.com / 123456
- **Director**: Solo email ‚Üí director@scalalearning.com
- **User**: Solo email ‚Üí user@scalalearning.com

**Nota**: Directores y usuarios no necesitan contrase√±a, solo email

## üìö Endpoints principales:

- **Usuarios**: Gesti√≥n de usuarios del sistema
- **Recursos**: Gesti√≥n de recursos
- **Alianzas**: Gesti√≥n de alianzas
- **Secciones**: Gesti√≥n de secciones
- **Documentaci√≥n**: Gesti√≥n de documentaci√≥n (solo admin)
      `,
      contact: {
        name: 'TechXcelerators Team',
        email: 'scalalearning25@gmail.com',
      },
    },
    servers: [
      {
        url: process.env.NODE_ENV === 'production' 
          ? 'https://scala-backend-42as.onrender.com' 
          : 'http://localhost:3000',
        description: process.env.NODE_ENV === 'production' ? 'Servidor de Producci√≥n' : 'Servidor de Desarrollo',
      },
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: `
## üîë Autenticaci√≥n JWT

Para usar endpoints protegidos:

1. **Paso 1**: Ejecuta \`POST /api/users/login\` con tus credenciales
2. **Paso 2**: Copia el \`token\` de la respuesta
3. **Paso 3**: Haz clic en **"Authorize"** üîí (bot√≥n verde arriba)
4. **Paso 4**: Pega el token (sin agregar "Bearer")
5. **Paso 5**: Haz clic en "Authorize" y luego "Close"

**Formato del token**: \`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\`

‚ö†Ô∏è **Importante**: NO agregues "Bearer" al token, Swagger lo hace autom√°ticamente.
          `
        },
      },
      schemas: {
        User: {
          type: 'object',
          properties: {
            _id: {
              type: 'string',
              description: 'ID √∫nico del usuario',
              example: '6716b52c43f33bf9f92e0850'
            },
            name: {
              type: 'string',
              description: 'Nombre del usuario',
              example: 'Juan P√©rez'
            },
            email: {
              type: 'string',
              format: 'email',
              description: 'Email del usuario',
              example: 'admin@scalalearning.com'
            },
            password: {
              type: 'string',
              description: 'Contrase√±a del usuario (solo para admin)',
              example: '123456'
            },
            role: {
              type: 'string',
              enum: ['admin', 'director', 'user'],
              description: 'Rol del usuario en el sistema',
              example: 'admin'
            }
          }
        },
        LoginResponse: {
          type: 'object',
          properties: {
            token: {
              type: 'string',
              description: 'üîë Token JWT - C√≥pialo y √∫salo en el bot√≥n Authorize',
              example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzE2YjUyYzQzZjMzYmY5ZjkyZTA4NTAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3Mjk1Mzg2MjAsImV4cCI6MTcyOTU0MjIyMH0.example'
            },
            user: {
              $ref: '#/components/schemas/User'
            }
          },
          example: {
            token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzE2YjUyYzQzZjMzYmY5ZjkyZTA4NTAiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3Mjk1Mzg2MjAsImV4cCI6MTcyOTU0MjIyMH0.example',
            user: {
              _id: '6716b52c43f33bf9f92e0850',
              name: 'Juan P√©rez',
              email: 'admin@scalalearning.com',
              role: 'admin'
            }
          }
        },
        Alliance: {
          type: 'object',
          properties: {
            _id: {
              type: 'string',
              description: 'ID √∫nico de la alianza'
            },
            name: {
              type: 'string',
              description: 'Nombre de la alianza'
            },
            siglas: {
              type: 'string',
              description: 'Siglas de la alianza'
            },
            url: {
              type: 'string',
              description: 'URL de la alianza'
            },
            logos: [
              {
                type: 'object',
                properties: {
                  label: {
                    type: 'string',
                    description: 'Descripci√≥n del logo'
                  },
                  url: {
                    type: 'string',
                    description: 'URL de la imagen del logo'
                  }
                }
              }
            ]
          }
        },
        Resource: {
          type: 'object',
          properties: {
            _id: {
              type: 'string',
              description: 'ID √∫nico del recurso'
            },
            name: {
              type: 'string',
              description: 'Nombre del recurso'
            },
            description: {
              type: 'string',
              description: 'Descripci√≥n del recurso'
            },
            sectionId: {
              type: 'string',
              description: 'ID de la secci√≥n a la que pertenece'
            },
            links: [
              {
                type: 'object',
                properties: {
                  label: {
                    type: 'string',
                    description: 'Texto del enlace'
                  },
                  url: {
                    type: 'string',
                    description: 'URL del recurso'
                  }
                }
              }
            ]
          }
        },
        Section: {
          type: 'object',
          properties: {
            _id: {
              type: 'string',
              description: 'ID √∫nico de la secci√≥n',
              example: '6716b52c43f33bf9f92e0850'
            },
            title: {
              type: 'string',
              description: 'T√≠tulo de la secci√≥n',
              example: 'Gobernanza'
            },
            description: {
              type: 'string',
              description: 'Descripci√≥n de la secci√≥n',
              example: 'Secci√≥n dedicada a recursos de gobernanza.'
            },
            resourcesId: {
              type: 'string',
              description: 'ID de los recursos asociados a esta secci√≥n',
              example: '6716b52c43f33bf9f92e0850'
            }
          }
        },
        Document: {
          type: 'object',
          properties: {
            _id: {
              type: 'string',
              description: 'ID √∫nico del documento',
              example: '6716b52c43f33bf9f92e0850'
            },
            name: {
              type: 'string',
              description: 'Nombre del archivo',
              example: 'Documento.pdf'
            },
            description: {
              type: 'string',
              description: 'Descripci√≥n del documento',
              example: 'Manual de usuario para la plataforma Scala Learning'
            },
            category: {
              type: 'string',
              description: 'Categor√≠a del documento',
              example: 'manual'
            },
            type: {
              type: 'string',
              description: 'Tipo MIME del documento',
              example: 'application/pdf'
            },
            url: {
              type: 'string',
              description: 'URL para acceder al documento',
              example: 'http://localhost:3000/uploads/1729538620_documento.pdf'
            },
            filepath: {
              type: 'string',
              description: 'Ruta real del archivo',
              example: 'c:/uploads/1729538620_documento.pdf'
            },
            size: {
              type: 'number',
              description: 'Tama√±o del archivo en bytes',
              example: 1024000
            },
            isVisible: [
              {
                type: 'string',
                enum: ['admin', 'director', 'user'],
                description: 'Roles que pueden ver el documento',
                example: 'user'
              }
            ],
            isDeleted: {
              type: 'boolean',
              description: 'Estado de eliminaci√≥n l√≥gica',
              example: false
            },
            uploadedBy: {
              type: 'string',
              description: 'Usuario que subi√≥ el archivo',
              example: 'admin'
            },
            createdAt: {
              type: 'string',
              format: 'date-time',
              description: 'Fecha de creaci√≥n',
              example: '2023-10-22T10:30:00Z'
            }
          }
        },
        Error: {
          type: 'object',
          properties: {
            message: {
              type: 'string',
              description: 'Mensaje de error'
            },
            error: {
              type: 'string',
              description: 'Detalles del error'
            }
          }
        },
        Success: {
          type: 'object',
          properties: {
            message: {
              type: 'string',
              description: 'Mensaje de √©xito'
            },
            data: {
              type: 'object',
              description: 'Datos de respuesta'
            }
          }
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  apis: [
    './src/routes/*.ts',
    './src/controllers/*.ts',
    './src/models/*.ts'
  ],
};

const specs = swaggerJSDoc(options);

export const setupSwagger = (app: Express): void => {
  // Swagger UI
  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs, {
    explorer: true,
    customCss: `
      .swagger-ui .topbar { display: none }
      .swagger-ui .info .title { color: #3b82f6 }
    `,
    customSiteTitle: 'Scala Learning API Documentation',
    swaggerOptions: {
      docExpansion: 'none',
      filter: true,
      showRequestDuration: true,
    }
  }));

  // Swagger JSON
  app.get('/api-docs.json', (_req, res) => {
    res.setHeader('Content-Type', 'application/json');
    res.send(specs);
  });

console.log('üìö Swagger documentation available at: http://localhost:3000/api-docs || https://scala-backend-42as.onrender.com/api-docs');
};

export { specs };